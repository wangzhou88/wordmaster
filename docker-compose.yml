version: '3.8'

services:
  # WordMaster Androidæ„å»ºæœåŠ¡
  wordmaster-builder:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wordmaster-apk-builder
    working_dir: /app
    
    # æŒ‚è½½é¡¹ç›®ç›®å½•
    volumes:
      - .:/app
      - wordmaster-cache:/root/.cache
      - wordmaster-gradle:/root/.gradle
    
    # ç¯å¢ƒå˜é‡
    environment:
      - JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
      - ANDROID_HOME=/opt/android-sdk
      - PYTHONUNBUFFERED=1
    
    # ç½‘ç»œè®¾ç½®
    network_mode: host
    
    # èµ„æºé™åˆ¶
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '1.0'
    
    # äº¤äº’å¼ç»ˆç«¯
    stdin_open: true
    tty: true
    
    # ä¾èµ–æœåŠ¡
    depends_on:
      - docker-host
    
    # å‘½ä»¤ï¼ˆå¯ä»¥é€šè¿‡docker-compose runè¦†ç›–ï¼‰
    command: >
      bash -c "
        echo 'ğŸš€ WordMaster Dockerç¯å¢ƒå°±ç»ªï¼' &&
        echo 'ğŸ“ é¡¹ç›®è·¯å¾„: /app' &&
        echo 'ğŸ“¦ å¯ç”¨å‘½ä»¤:' &&
        echo '  p4a --version        # æ£€æŸ¥python-for-androidç‰ˆæœ¬' &&
        echo '  p4a apk --private /app --name wordmaster --package com.wordmaster.app' &&
        echo '  ls -la /app          # æŸ¥çœ‹é¡¹ç›®æ–‡ä»¶' &&
        echo '' &&
        bash
      "
  
  # Dockerä¸»æœºæœåŠ¡ï¼ˆç”¨äºDocker-in-Dockeræ”¯æŒï¼‰
  docker-host:
    image: docker:24-dind
    container_name: docker-host
    privileged: true
    environment:
      - DOCKER_TLS_CERTDIR=
      - DOCKER_BUILDKIT=1
    volumes:
      - wordmaster-docker-data:/var/lib/docker
    
  # å¿«é€Ÿæ„å»ºæœåŠ¡ï¼ˆä¸€æ¬¡æ€§æ„å»ºï¼‰
  quick-build:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wordmaster-quick-build
    working_dir: /app
    
    volumes:
      - .:/app
    
    environment:
      - JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
      - ANDROID_HOME=/opt/android-sdk
    
    # è¿è¡Œæ„å»ºç„¶åé€€å‡º
    command: >
      bash -c "
        echo 'ğŸš€ å¼€å§‹WordMaster APKæ„å»º...' &&
        p4a apk --private /app --name wordmaster --package com.wordmaster.app --android-api 31 &&
        echo 'âœ… æ„å»ºå®Œæˆï¼' &&
        ls -la bin/ &&
        echo 'APKæ–‡ä»¶å·²ç”Ÿæˆåœ¨binç›®å½•ä¸­'
      "
    
    # å®Œæˆåè‡ªåŠ¨åˆ é™¤
    restart: "no"
    stdin_open: false
    tty: false

# æ•°æ®å·
volumes:
  wordmaster-cache:
    driver: local
  wordmaster-gradle:
    driver: local
  wordmaster-docker-data:
    driver: local

# ç½‘ç»œ
networks:
  default:
    name: wordmaster-network
    driver: bridge