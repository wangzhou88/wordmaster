name: ðŸ“± WordMaster APKæž„å»º (ç®€åŒ–ç‰ˆ)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æž„å»ºç±»åž‹'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
      main_file:
        description: 'ä¸»æ–‡ä»¶'
        required: true
        default: 'main_simple.py'
        type: string
      spec_file:
        description: 'Specæ–‡ä»¶'
        required: true
        default: 'buildozer_minimal.spec'
        type: string

env:
  PYTHON_VERSION: '3.11'

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ðŸ”§ è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ðŸ” æ£€æŸ¥æž„å»ºçŽ¯å¢ƒ
      run: |
        echo "=== Pythonç‰ˆæœ¬ ==="
        python --version
        pip --version
        
        echo "=== AndroidçŽ¯å¢ƒ ==="
        echo "ANDROID_HOME: $ANDROID_HOME"
        if [ -d "$ANDROID_HOME" ]; then
          echo "Android SDKç›®å½•å­˜åœ¨"
          ls -la $ANDROID_HOME
          echo "=== å·²å®‰è£…çš„SDKå¹³å° ==="
          ls -la $ANDROID_HOME/platforms/
          echo "=== å·²å®‰è£…çš„SDKå·¥å…· ==="
          ls -la $ANDROID_HOME/cmdline-tools/
          echo "=== å·²å®‰è£…çš„æž„å»ºå·¥å…· ==="
          ls -la $ANDROID_HOME/build-tools/
        else
          echo "Android SDKç›®å½•ä¸å­˜åœ¨"
        fi
        
        echo "=== JavaçŽ¯å¢ƒ ==="
        echo "JAVA_HOME: $JAVA_HOME"
        if [ -d "$JAVA_HOME" ]; then
          echo "Javaå®‰è£…ç›®å½•å­˜åœ¨"
          java -version
        else
          echo "Javaå®‰è£…ç›®å½•ä¸å­˜åœ¨"
        fi
        
        echo "=== buildozerç‰ˆæœ¬ ==="
        buildozer --version || echo "buildozeræœªå®‰è£…"
        
    - name: ðŸ”„ å‡çº§åŸºç¡€å·¥å…·
      run: |
        echo "=== å‡çº§pipå’ŒåŸºç¡€å·¥å…· ==="
        python -m pip install --upgrade pip setuptools wheel
        
    - name: ðŸ‡¨ðŸ‡³ é…ç½®pipé•œåƒæº
      run: |
        echo "=== é…ç½®pipé•œåƒæº ==="
        mkdir -p ~/.pip
        echo '[global]' > ~/.pip/pip.conf
        echo 'index-url = https://pypi.tuna.tsinghua.edu.cn/simple' >> ~/.pip/pip.conf
        echo 'trusted-host = pypi.tuna.tsinghua.edu.cn' >> ~/.pip/pip.conf
        echo 'timeout = 120' >> ~/.pip/pip.conf
        echo 'retries = 3' >> ~/.pip/pip.conf
        echo "Pipé•œåƒé…ç½®åˆ›å»ºæˆåŠŸ"
        
    - name: ðŸ“¦ å®‰è£…Pythonæž„å»ºä¾èµ–
      run: |
        echo "=== å®‰è£…Pythonæž„å»ºä¾èµ– ==="
        pip install cython==0.29.33
        
    - name: ðŸ“² å®‰è£…Androidæž„å»ºå·¥å…·
      run: |
        echo "=== å®‰è£…Androidæž„å»ºå·¥å…· ==="
        pip install python-for-android==2024.1.21
        pip install buildozer==1.5.0
        
    - name: ðŸ” éªŒè¯æž„å»ºå·¥å…·
      run: |
        echo "=== éªŒè¯æž„å»ºå·¥å…· ==="
        python --version
        pip --version
        buildozer --version
        
    - name: ðŸ“ å‡†å¤‡æž„å»ºæ–‡ä»¶
      run: |
        echo "=== å‡†å¤‡æž„å»ºæ–‡ä»¶ ==="
        echo "ä¸»æ–‡ä»¶: ${{ github.event.inputs.main_file || 'main_simple.py' }}"
        echo "Specæ–‡ä»¶: ${{ github.event.inputs.spec_file || 'buildozer_minimal.spec' }}"
        
        # å¤åˆ¶ç®€åŒ–ç‰ˆæ–‡ä»¶ä¸ºä¸»æ–‡ä»¶
        if [ ! -f "main.py" ]; then
          cp "${{ github.event.inputs.main_file || 'main_simple.py' }}" main.py
        fi
        
        # å¤åˆ¶ç®€åŒ–ç‰ˆspecæ–‡ä»¶
        if [ ! -f "buildozer.spec" ]; then
          cp "${{ github.event.inputs.spec_file || 'buildozer_minimal.spec' }}" buildozer.spec
        fi
        
        # åˆ—å‡ºæž„å»ºæ–‡ä»¶
        echo "æž„å»ºæ–‡ä»¶å†…å®¹:"
        cat buildozer.spec
        
    - name: âš™ï¸ é…ç½®AndroidçŽ¯å¢ƒ
      run: |
        echo "=== é…ç½®AndroidçŽ¯å¢ƒ ==="
        export ANDROID_HOME=/opt/android-sdk
        export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
        
        # åˆ›å»ºæœ¬åœ°.propertiesæ–‡ä»¶
        mkdir -p ~/.android
        echo "sdk.dir=$ANDROID_HOME" > ~/.android/local.properties
        
        # è®¾ç½®JavaçŽ¯å¢ƒ
        export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
        
        echo "=== éªŒè¯AndroidçŽ¯å¢ƒ ==="
        sdkmanager --list || echo "æ— æ³•åˆ—å‡ºSDKç»„ä»¶"
        
    - name: ðŸ§¹ æ¸…ç†ä¹‹å‰çš„æž„å»º
      run: |
        echo "=== æ¸…ç†ä¹‹å‰çš„æž„å»º ==="
        export ANDROID_HOME=/opt/android-sdk
        export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
        buildozer android clean || true
        
    - name: ðŸš€ å¼€å§‹æž„å»ºAPK
      run: |
        echo "=== å¼€å§‹æž„å»ºAPK ==="
        echo "æž„å»ºç±»åž‹: ${{ github.event.inputs.build_type || 'debug' }}"
        
        export ANDROID_HOME=/opt/android-sdk
        export PATH=$PATH:$ANDROID_HOME/tools:$ANDROID_HOME/platform-tools
        export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
        
        if [ "${{ github.event.inputs.build_type }}" = "release" ]; then
          echo "æž„å»ºReleaseç‰ˆæœ¬APK..."
          buildozer android release --verbose
        else
          echo "æž„å»ºDebugç‰ˆæœ¬APK..."
          buildozer android debug --verbose
        fi
        
    - name: ðŸ” æ£€æŸ¥æž„å»ºç»“æžœ
      run: |
        echo "=== æŸ¥æ‰¾æž„å»ºäº§ç‰© ==="
        
        if [ -d "bin" ]; then
          echo "binç›®å½•å†…å®¹:"
          ls -la bin/
        else
          echo "æœªæ‰¾åˆ°binç›®å½•"
        fi
        
        echo "=== æŸ¥æ‰¾APKæ–‡ä»¶ ==="
        APK_FILES=$(find . -name "*.apk" -type f 2>/dev/null | head -5)
        if [ -n "$APK_FILES" ]; then
          echo "æ‰¾åˆ°APKæ–‡ä»¶:"
          echo "$APK_FILES"
          for apk in $APK_FILES; do
            echo "APKæ–‡ä»¶: $apk - å¤§å°: $(du -h "$apk" | cut -f1)"
          done
        else
          echo "æœªæ‰¾åˆ°APKæ–‡ä»¶"
        fi
        
        echo "=== æŸ¥æ‰¾AABæ–‡ä»¶ ==="
        AAB_FILES=$(find . -name "*.aab" -type f 2>/dev/null | head -5)
        if [ -n "$AAB_FILES" ]; then
          echo "æ‰¾åˆ°AABæ–‡ä»¶:"
          echo "$AAB_FILES"
        else
          echo "æœªæ‰¾åˆ°AABæ–‡ä»¶ï¼ˆæ­£å¸¸ï¼Œä»…Releaseç‰ˆæœ¬ä¼šæœ‰ï¼‰"
        fi
        
    - name: ðŸ“¤ ä¸Šä¼ APKäº§ç‰©
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: wordmaster-apk-${{ github.sha }}-${{ github.event.inputs.build_type || 'debug' }}
        path: |
          bin/*.apk
          bin/*.aab
        retention-days: 30
        
    - name: ðŸ“¤ ä¸Šä¼ æž„å»ºæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.sha }}
        path: |
          .buildozer/android/app/build/outputs/
          .buildozer/android/logs/
          *.log
        retention-days: 7
        
    - name: ðŸ“Š æž„å»ºæ€»ç»“
      if: always()
      run: |
        echo "## ðŸ“± WordMaster APKæž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”§ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºç±»åž‹**: \`${{ github.event.inputs.build_type || 'debug' }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Pythonç‰ˆæœ¬**: \`${{ env.PYTHON_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºæ—¶é—´**: \`$(date)\`" >> $GITHUB_STEP_SUMMARY
        echo "- **è¿è¡ŒçŽ¯å¢ƒ**: \`${{ runner.os }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“± æž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥æž„å»ºç»“æžœ
        BUILD_SUCCESS=false
        APK_COUNT=0
        
        if [ -d "bin" ]; then
          APK_COUNT=$(find bin -name "*.apk" -type f 2>/dev/null | wc -l)
          if [ $APK_COUNT -gt 0 ]; then
            BUILD_SUCCESS=true
          fi
        fi
        
        if [ "$BUILD_SUCCESS" = true ]; then
          echo "âœ… **APKæž„å»ºæˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç”Ÿæˆçš„APKæ–‡ä»¶:**" >> $GITHUB_STEP_SUMMARY
          find bin -name "*.apk" -type f 2>/dev/null | while read apk; do
            size=$(du -h "$apk" | cut -f1)
            filename=$(basename "$apk")
            echo "- ðŸ“± \`$filename\` ($size)" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ”½ ä¸‹è½½é“¾æŽ¥**: åœ¨é¡µé¢åº•éƒ¨çš„ArtifactsåŒºåŸŸä¸‹è½½APKæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **APKæž„å»ºå¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ”§ æ•…éšœæŽ’é™¤å»ºè®®:**" >> $GITHUB_STEP_SUMMARY
          echo "1. æ£€æŸ¥æž„å»ºæ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "2. ç¡®è®¤ \`buildozer.spec\` é…ç½®æ–‡ä»¶æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
          echo "3. éªŒè¯é¡¹ç›®ä¾èµ–æ˜¯å¦å®Œæ•´" >> $GITHUB_STEP_SUMMARY
          echo "4. æŸ¥çœ‹ \`.buildozer\` ç›®å½•ä¸­çš„è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*æ­¤æž„å»ºç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*" >> $GITHUB_STEP_SUMMARY