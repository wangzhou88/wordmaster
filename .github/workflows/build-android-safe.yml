name: ğŸ›¡ï¸ WordMaster APKæ„å»º (å®‰å…¨ç‰ˆ)

on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/*.yml'
      - 'main.py'
      - 'buildozer.spec'
      - 'requirements.txt'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æ„å»ºç±»å‹'
        required: false
        default: 'debug'
        type: choice
        options:
        - debug
        - release
      main_file:
        description: 'ä¸»æ–‡ä»¶'
        required: false
        default: 'main_simple.py'
      spec_file:
        description: 'Specæ–‡ä»¶'
        required: false
        default: 'buildozer_minimal.spec'

jobs:
  build-apk:
    name: æ„å»ºAPKæ–‡ä»¶
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    env:
      PYTHON_VERSION: '3.11'
      ANDROID_API: '31'
      ANDROID_ARCH: 'arm64-v8a'
    
    steps:
    - name: ğŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ğŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        echo "=== æ›´æ–°ç³»ç»ŸåŒ… ==="
        sudo apt-get update -y
        
        echo "=== å®‰è£…æ„å»ºå·¥å…· ==="
        sudo apt-get install -y --no-install-recommends \
            build-essential \
            git \
            curl \
            wget \
            unzip \
            software-properties-common \
            apt-transport-https \
            ca-certificates \
            gnupg \
            lsb-release
            
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ– ==="
        sudo apt-get install -y --no-install-recommends \
            libssl-dev \
            zlib1g-dev \
            libbz2-dev \
            libreadline-dev \
            libsqlite3-dev \
            llvm \
            libncurses5-dev \
            libncursesw5-dev \
            xz-utils \
            tk-dev \
            libffi-dev \
            liblzma-dev \
            libstdc++6
            
        echo "=== å®‰è£…Androidå’ŒJavaå·¥å…· ==="
        sudo apt-get install -y --no-install-recommends \
            openjdk-17-jdk \
            android-tools-adb \
            android-tools-fastboot \
            ant \
            maven
            
        echo "=== éªŒè¯å®‰è£… ==="
        java -version
        javac -version
        
    - name: ğŸ”„ å‡çº§åŸºç¡€å·¥å…·
      run: |
        echo "=== å‡çº§pipå’ŒåŸºç¡€å·¥å…· ==="
        python -m pip install --upgrade pip setuptools wheel
        
    - name: ğŸ‡¨ğŸ‡³ é…ç½®pipé•œåƒæº
      run: |
        echo "=== é…ç½®pipé•œåƒæº ==="
        mkdir -p ~/.pip
        echo '[global]' > ~/.pip/pip.conf
        echo 'index-url = https://pypi.tuna.tsinghua.edu.cn/simple' >> ~/.pip/pip.conf
        echo 'trusted-host = pypi.tuna.tsinghua.edu.cn' >> ~/.pip/pip.conf
        echo 'timeout = 120' >> ~/.pip/pip.conf
        echo 'retries = 3' >> ~/.pip/pip.conf
        echo "Pipé•œåƒé…ç½®åˆ›å»ºæˆåŠŸ"
        
    - name: ğŸ“¦ å®‰è£…Pythonæ„å»ºä¾èµ–
      run: |
        echo "=== å®‰è£…Pythonæ„å»ºä¾èµ– ==="
        pip install cython==0.29.33
        
    - name: ğŸ“² å®‰è£…Androidæ„å»ºå·¥å…·
      run: |
        echo "=== å®‰è£…Androidæ„å»ºå·¥å…· ==="
        pip install python-for-android==2024.1.21
        pip install buildozer==1.5.0
        
    - name: ğŸ” éªŒè¯æ„å»ºå·¥å…·
      run: |
        echo "=== éªŒè¯æ„å»ºå·¥å…· ==="
        python --version
        pip --version
        buildozer --version
        
    - name: ğŸ“ å‡†å¤‡æ„å»ºæ–‡ä»¶
      run: |
        echo "=== å‡†å¤‡æ„å»ºæ–‡ä»¶ ==="
        echo "ä¸»æ–‡ä»¶: ${{ github.event.inputs.main_file || 'main_simple.py' }}"
        echo "Specæ–‡ä»¶: ${{ github.event.inputs.spec_file || 'buildozer_minimal.spec' }}"
        
        # å¤åˆ¶ç®€åŒ–ç‰ˆæ–‡ä»¶ä¸ºä¸»æ–‡ä»¶
        if [ ! -f "main.py" ]; then
          cp "${{ github.event.inputs.main_file || 'main_simple.py' }}" main.py
        fi
        
        # å¤åˆ¶ç®€åŒ–ç‰ˆspecæ–‡ä»¶
        if [ ! -f "buildozer.spec" ]; then
          cp "${{ github.event.inputs.spec_file || 'buildozer_minimal.spec' }}" buildozer.spec
        fi
        
        # åˆ—å‡ºæ„å»ºæ–‡ä»¶
        echo "æ„å»ºæ–‡ä»¶å†…å®¹:"
        cat buildozer.spec
        
    - name: ğŸ›¡ï¸ å®‰å…¨æ¸…ç†æ„å»ºç¯å¢ƒ
      run: |
        echo "=== å®‰å…¨æ¸…ç†æ„å»ºç¯å¢ƒ ==="
        # å®‰å…¨çš„æ¸…ç†æ–¹æ³•ï¼Œé¿å…åˆ é™¤ä¸å­˜åœ¨çš„ç›®å½•
        rm -rf .buildozer/android/platform/python-for-android 2>/dev/null || true
        rm -rf bin/*.apk bin/*.aab 2>/dev/null || true
        rm -rf .buildozer/android/platform/build 2>/dev/null || true
        echo "æ¸…ç†å®Œæˆ"
        
    - name: âš™ï¸ é…ç½®Androidç¯å¢ƒ
      run: |
        echo "=== é…ç½®Androidç¯å¢ƒ ==="
        
        # è®¾ç½®Javaç¯å¢ƒï¼ˆä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„OpenJDK 17ï¼‰
        export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
        export PATH=$JAVA_HOME/bin:$PATH
        
        # åˆ›å»ºAndroid SDKç›®å½•
        mkdir -p /opt/android-sdk
        
        # è®¾ç½®Androidç¯å¢ƒå˜é‡
        export ANDROID_HOME=/opt/android-sdk
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/34.0.0:$PATH
        
        # åˆ›å»ºæœ¬åœ°.propertiesæ–‡ä»¶
        mkdir -p ~/.android
        echo "sdk.dir=$ANDROID_HOME" > ~/.android/local.properties
        
        echo "=== éªŒè¯Javaç¯å¢ƒ ==="
        java -version
        
    - name: ğŸ”§ å®‰è£…Android SDK (å®Œæ•´ä¿®å¤ç‰ˆ)
      run: |
        echo "=== å®‰è£…Android SDK (å®Œæ•´ä¿®å¤ç‰ˆ) ==="
        
        # è®¾ç½®åŸºç¡€ç¯å¢ƒå˜é‡
        export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
        export ANDROID_HOME=/opt/android-sdk
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export PATH=$JAVA_HOME/bin:$PATH
        
        echo "=== éªŒè¯Javaç¯å¢ƒ ==="
        java -version
        echo "JAVA_HOME: $JAVA_HOME"
        
        # åˆ›å»ºAndroid SDKç›®å½•ç»“æ„
        mkdir -p $ANDROID_HOME
        mkdir -p /tmp/android-sdk-temp
        
        echo "=== ä¸‹è½½Androidå‘½ä»¤è¡Œå·¥å…· ==="
        cd /tmp/android-sdk-temp
        curl -L -f -o commandlinetools.zip \
          "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip"
        
        echo "=== è§£å‹å’Œé…ç½®å‘½ä»¤è¡Œå·¥å…· ==="
        unzip -q commandlinetools.zip
        mkdir -p $ANDROID_HOME/cmdline-tools
        mv cmdline-tools $ANDROID_HOME/cmdline-tools/latest
        
        # æ›´æ–°PATHä»¥åŒ…å«sdkmanager
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$PATH
        
        echo "=== æ¥å—SDKè®¸å¯è¯ ==="
        yes | sdkmanager --sdk_root=$ANDROID_HOME --licenses || true
        
        echo "=== å®‰è£…æ ¸å¿ƒSDKç»„ä»¶ ==="
        sdkmanager --sdk_root=$ANDROID_HOME \
          "platform-tools" \
          "platforms;android-31" \
          "build-tools;34.0.0"
        
        echo "=== éªŒè¯SDKå®‰è£…ç»“æœ ==="
        ls -la $ANDROID_HOME/
        echo "=== æ£€æŸ¥build-toolsç›®å½• ==="
        ls -la $ANDROID_HOME/build-tools/ 2>/dev/null || echo "build-toolsç›®å½•ä¸å­˜åœ¨"
        
        echo "=== éªŒè¯AIDLå·¥å…·å®‰è£… ==="
        if [ -f "$ANDROID_HOME/build-tools/34.0.0/aidl" ]; then
          echo "âœ… AIDLå·¥å…·å·²æ‰¾åˆ° (build-tools 34.0.0)"
          $ANDROID_HOME/build-tools/34.0.0/aidl --version
          export PATH=$ANDROID_HOME/build-tools/34.0.0:$PATH
        else
          echo "âŒ AIDLå·¥å…·æœªæ‰¾åˆ°ï¼Œå°è¯•å¤‡ç”¨æ–¹æ¡ˆ..."
          # å°è¯•å®‰è£…å¤‡ç”¨ç‰ˆæœ¬
          sdkmanager --sdk_root=$ANDROID_HOME "build-tools;33.0.2"
          if [ -f "$ANDROID_HOME/build-tools/33.0.2/aidl" ]; then
            echo "âœ… AIDLå·¥å…·å·²æ‰¾åˆ° (build-tools 33.0.2)"
            $ANDROID_HOME/build-tools/33.0.2/aidl --version
            export PATH=$ANDROID_HOME/build-tools/33.0.2:$PATH
          else
            echo "âŒ æ‰€æœ‰AIDLå·¥å…·å®‰è£…å¤±è´¥"
            exit 1
          fi
        fi
        
        # æœ€ç»ˆPATHé…ç½®
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/34.0.0:$PATH
        echo "=== æœ€ç»ˆPATHé…ç½® ==="
        echo "PATH: $PATH"
        echo "=== éªŒè¯aidlå‘½ä»¤ ==="
        which aidl || echo "aidlå‘½ä»¤ä¸åœ¨PATHä¸­"
        
    - name: ğŸš€ æ„å»ºAPK (ç®€åŒ–æ¨¡å¼)
      run: |
        echo "=== å¼€å§‹æ„å»ºAPK ==="
        echo "æ„å»ºç±»å‹: ${{ github.event.inputs.build_type || 'debug' }}"
        
        export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
        export ANDROID_HOME=/opt/android-sdk
        export ANDROID_SDK_ROOT=$ANDROID_HOME
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$ANDROID_HOME/build-tools/34.0.0:$PATH
        
        echo "=== æ„å»ºå‰éªŒè¯ç¯å¢ƒ ==="
        echo "JAVA_HOME: $JAVA_HOME"
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "PATHåŒ…å«AIDL: $(echo $PATH | grep -o 'build-tools/34.0.0')"
        
        # ä½¿ç”¨ç®€åŒ–çš„æ„å»ºå‘½ä»¤ï¼Œé¿å…å¤æ‚æ¸…ç†
        if [ "${{ github.event.inputs.build_type }}" = "release" ]; then
          echo "æ„å»ºReleaseç‰ˆæœ¬APK..."
          buildozer android release --verbose
        else
          echo "æ„å»ºDebugç‰ˆæœ¬APK..."
          buildozer android debug --verbose
        fi
        
    - name: ğŸ“Š æ£€æŸ¥æ„å»ºç»“æœ
      run: |
        echo "=== æŸ¥æ‰¾æ„å»ºäº§ç‰© ==="
        
        if [ -d "bin" ]; then
          echo "binç›®å½•å†…å®¹:"
          ls -la bin/
        else
          echo "âŒ æœªæ‰¾åˆ°binç›®å½•"
        fi
        
        echo "=== æŸ¥æ‰¾APKæ–‡ä»¶ ==="
        APK_FILES=$(find . -name "*.apk" -type f 2>/dev/null | head -5)
        if [ -n "$APK_FILES" ]; then
          echo "æ‰¾åˆ°APKæ–‡ä»¶:"
          echo "$APK_FILES"
          for apk in $APK_FILES; do
            echo "ğŸ“± $apk - å¤§å°: $(du -h "$apk" | cut -f1)"
          done
        else
          echo "âŒ æœªæ‰¾åˆ°APKæ–‡ä»¶"
        fi
        
        echo "=== æŸ¥æ‰¾AABæ–‡ä»¶ ==="
        AAB_FILES=$(find . -name "*.aab" -type f 2>/dev/null | head -5)
        if [ -n "$AAB_FILES" ]; then
          echo "æ‰¾åˆ°AABæ–‡ä»¶:"
          echo "$AAB_FILES"
        else
          echo "â„¹ï¸ æœªæ‰¾åˆ°AABæ–‡ä»¶ï¼ˆæ­£å¸¸ï¼Œä»…Releaseç‰ˆæœ¬ä¼šæœ‰ï¼‰"
        fi
        
    - name: ğŸ“¦ ä¸Šä¼ APKäº§ç‰©
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: wordmaster-apk-safe-${{ github.sha }}-${{ github.event.inputs.build_type || 'debug' }}
        path: |
          bin/*.apk
          bin/*.aab
        retention-days: 30