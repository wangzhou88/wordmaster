name: ðŸ“± WordMaster APKæž„å»º

on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/*.yml'
      - 'main.py'
      - 'buildozer.spec'
      - 'requirements.txt'
  workflow_dispatch:
    inputs:
      build_type:
        description: 'æž„å»ºç±»åž‹'
        required: false
        default: 'debug'
        type: choice
        options:
        - debug
        - release

jobs:
  build-apk:
    name: æž„å»ºAPKæ–‡ä»¶
    runs-on: ubuntu-22.04
    timeout-minutes: 180
    
    env:
      PYTHON_VERSION: '3.11'
      ANDROID_API: '31'
      ANDROID_ARCH: 'arm64-v8a'
    
    steps:
    - name: ðŸ“¥ æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ðŸ è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ðŸ“¦ å®‰è£…ç³»ç»Ÿä¾èµ–
      run: |
        echo "=== æ›´æ–°ç³»ç»ŸåŒ… ==="
        sudo apt-get update -y
        
        echo "=== å®‰è£…æž„å»ºå·¥å…· ==="
        sudo apt-get install -y --no-install-recommends \
            build-essential \
            git \
            curl \
            wget \
            unzip \
            software-properties-common \
            apt-transport-https \
            ca-certificates \
            gnupg \
            lsb-release
            
        echo "=== å®‰è£…ç¼–è¯‘ä¾èµ– ==="
        sudo apt-get install -y --no-install-recommends \
            libssl-dev \
            zlib1g-dev \
            libbz2-dev \
            libreadline-dev \
            libsqlite3-dev \
            llvm \
            libncurses5-dev \
            libncursesw5-dev \
            xz-utils \
            tk-dev \
            libffi-dev \
            liblzma-dev \
            libstdc++6
            
        echo "=== å®‰è£…Androidå’ŒJavaå·¥å…· ==="
        sudo apt-get install -y --no-install-recommends \
            openjdk-11-jdk \
            android-tools-adb \
            android-tools-fastboot \
            ant \
            maven
            
        echo "=== éªŒè¯å®‰è£… ==="
        java -version
        javac -version
        
    - name: ðŸ”§ å®‰è£…æž„å»ºå·¥å…·
      run: |
        echo "=== å‡çº§pipå’ŒåŸºç¡€å·¥å…· ==="
        python -m pip install --upgrade pip setuptools wheel
        
        echo "=== é…ç½®pipé•œåƒæº ==="
        mkdir -p ~/.pip
        echo '[global]' > ~/.pip/pip.conf
        echo 'index-url = https://pypi.tuna.tsinghua.edu.cn/simple' >> ~/.pip/pip.conf
        echo 'trusted-host = pypi.tuna.tsinghua.edu.cn' >> ~/.pip/pip.conf
        echo 'timeout = 120' >> ~/.pip/pip.conf
        echo 'retries = 3' >> ~/.pip/pip.conf
        echo "Pipé•œåƒé…ç½®åˆ›å»ºæˆåŠŸ"
        
        echo "=== å®‰è£…Pythonæž„å»ºä¾èµ– ==="
        pip install cython==0.29.33
        
        echo "=== å®‰è£…Androidæž„å»ºå·¥å…· ==="
        pip install python-for-android==2024.6.15
        pip install buildozer==1.5.0
        
        echo "=== éªŒè¯æž„å»ºå·¥å…· ==="
        python --version
        pip --version
        buildozer --version
        
    - name: ðŸŒ é…ç½®ç½‘ç»œå’ŒGit
      run: |
        echo "=== é…ç½®Git ==="
        
        # é…ç½®Gitä½¿ç”¨é•œåƒæº
        git config --global url."https://ghproxy.com/https://github.com/".insteadOf "https://github.com/"
        git config --global url."https://ghproxy.com/https://raw.githubusercontent.com/".insteadOf "https://raw.githubusercontent.com/"
        
        # é…ç½®Gitè¿žæŽ¥ä¼˜åŒ–
        git config --global http.postBuffer 524288000
        git config --global http.lowSpeedLimit 0
        git config --global http.lowSpeedTime 999999
        git config --global core.preloadindex true
        git config --global core.fscache true
        git config --global gc.auto 256
        
        echo "=== Gité…ç½®éªŒè¯ ==="
        git config --global --list | head -10
        
    - name: ðŸ“± å®‰è£…Android SDK
      run: |
        echo "=== åˆ›å»ºAndroid SDKç›®å½• ==="
        mkdir -p /home/runner/android-sdk
        
        echo "=== ä¸‹è½½Androidå‘½ä»¤è¡Œå·¥å…· ==="
        cd /tmp
        if curl -L -f -o commandlinetools.zip \
          "https://mirrors.neusoft.edu.cn/android/repository/commandlinetools-linux-9477386_latest.zip"; then
          echo "ä½¿ç”¨å›½å†…é•œåƒä¸‹è½½æˆåŠŸ"
        else
          echo "å›½å†…é•œåƒå¤±è´¥ï¼Œä½¿ç”¨å®˜æ–¹æº"
          curl -L -f -o commandlinetools.zip \
            "https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip"
        fi
        
        echo "=== è§£åŽ‹å’Œé…ç½®SDK ==="
        unzip -q commandlinetools.zip
        mkdir -p /home/runner/android-sdk/cmdline-tools
        mv cmdline-tools /home/runner/android-sdk/cmdline-tools/latest
        
        echo "=== è®¾ç½®çŽ¯å¢ƒå˜é‡ ==="
        echo "ANDROID_HOME=/home/runner/android-sdk" >> $GITHUB_ENV
        echo "PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH" >> $GITHUB_ENV
        
        export ANDROID_HOME=/home/runner/android-sdk
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
        
        echo "=== æŽ¥å—Android SDKè®¸å¯è¯ ==="
        yes | sdkmanager --sdk_root=/home/runner/android-sdk --licenses || true
        
        echo "=== å®‰è£…Android SDKç»„ä»¶ ==="
        sdkmanager --sdk_root=/home/runner/android-sdk \
          "platform-tools" \
          "platforms;android-${{ env.ANDROID_API }}" \
          "build-tools;33.0.2"
        
        echo "=== éªŒè¯SDKå®‰è£… ==="
        sdkmanager --list | head -10
        
    - name: ðŸ” æ£€æŸ¥æž„å»ºçŽ¯å¢ƒ
      run: |
        echo "=== éªŒè¯æž„å»ºå·¥å…·ç‰ˆæœ¬ ==="
        python --version
        pip --version
        buildozer --version
        java -version
        
        echo "=== æ£€æŸ¥çŽ¯å¢ƒå˜é‡ ==="
        echo "ANDROID_HOME: $ANDROID_HOME"
        echo "JAVA_HOME: $JAVA_HOME"
        echo "PYTHON_VERSION: ${{ env.PYTHON_VERSION }}"
        
    - name: ðŸš€ æž„å»ºAPK
      run: |
        echo "=== è®¾ç½®æž„å»ºçŽ¯å¢ƒå˜é‡ ==="
        export ANDROID_HOME=/home/runner/android-sdk
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
        export JAVA_HOME=/usr/lib/jvm/java-11-openjdk-amd64
        
        echo "=== æ¸…ç†ä¹‹å‰çš„æž„å»º ==="
        buildozer android clean || true
        
        echo "=== å¼€å§‹æž„å»ºAPK ==="
        echo "æž„å»ºç±»åž‹: ${{ github.event.inputs.build_type || 'debug' }}"
        
        if [ "${{ github.event.inputs.build_type }}" = "release" ]; then
          echo "æž„å»ºReleaseç‰ˆæœ¬APK..."
          buildozer android release --verbose
        else
          echo "æž„å»ºDebugç‰ˆæœ¬APK..."
          buildozer android debug --verbose
        fi
        
    - name: ðŸ“Š æ£€æŸ¥æž„å»ºç»“æžœ
      run: |
        echo "=== æŸ¥æ‰¾æž„å»ºäº§ç‰© ==="
        
        if [ -d "bin" ]; then
          echo "binç›®å½•å†…å®¹:"
          ls -la bin/
        else
          echo "âŒ æœªæ‰¾åˆ°binç›®å½•"
        fi
        
        echo "=== æŸ¥æ‰¾APKæ–‡ä»¶ ==="
        APK_FILES=$(find . -name "*.apk" -type f 2>/dev/null | head -5)
        if [ -n "$APK_FILES" ]; then
          echo "æ‰¾åˆ°APKæ–‡ä»¶:"
          echo "$APK_FILES"
          for apk in $APK_FILES; do
            echo "ðŸ“± $apk - å¤§å°: $(du -h "$apk" | cut -f1)"
          done
        else
          echo "âŒ æœªæ‰¾åˆ°APKæ–‡ä»¶"
        fi
        
        echo "=== æŸ¥æ‰¾AABæ–‡ä»¶ ==="
        AAB_FILES=$(find . -name "*.aab" -type f 2>/dev/null | head -5)
        if [ -n "$AAB_FILES" ]; then
          echo "æ‰¾åˆ°AABæ–‡ä»¶:"
          echo "$AAB_FILES"
        else
          echo "â„¹ï¸ æœªæ‰¾åˆ°AABæ–‡ä»¶ï¼ˆæ­£å¸¸ï¼Œä»…Releaseç‰ˆæœ¬ä¼šæœ‰ï¼‰"
        fi
        
    - name: ðŸ“¦ ä¸Šä¼ APKäº§ç‰©
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: wordmaster-apk-${{ github.sha }}-${{ github.event.inputs.build_type || 'debug' }}
        path: |
          bin/*.apk
          bin/*.aab
        retention-days: 30
        
    - name: ðŸ“‹ ä¸Šä¼ æž„å»ºæ—¥å¿—
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs-${{ github.sha }}
        path: |
          .buildozer/android/app/build/outputs/
          .buildozer/android/logs/
          *.log
        retention-days: 7
        
    - name: ðŸ“ æž„å»ºæ‘˜è¦
      if: always()
      run: |
        echo "## ðŸ“± WordMaster APKæž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ æž„å»ºä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºç±»åž‹**: \`${{ github.event.inputs.build_type || 'debug' }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **Pythonç‰ˆæœ¬**: \`${{ env.PYTHON_VERSION }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **æž„å»ºæ—¶é—´**: \`$(date)\`" >> $GITHUB_STEP_SUMMARY
        echo "- **è¿è¡Œå™¨**: \`${{ runner.os }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        echo "### ðŸ“± æž„å»ºç»“æžœ" >> $GITHUB_STEP_SUMMARY
        
        # æ£€æŸ¥æž„å»ºç»“æžœ
        BUILD_SUCCESS=false
        APK_COUNT=0
        
        if [ -d "bin" ]; then
          APK_COUNT=$(find bin -name "*.apk" -type f 2>/dev/null | wc -l)
          if [ $APK_COUNT -gt 0 ]; then
            BUILD_SUCCESS=true
          fi
        fi
        
        if [ "$BUILD_SUCCESS" = true ]; then
          echo "âœ… **APKæž„å»ºæˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ç”Ÿæˆçš„APKæ–‡ä»¶:**" >> $GITHUB_STEP_SUMMARY
          find bin -name "*.apk" -type f 2>/dev/null | while read apk; do
            size=$(du -h "$apk" | cut -f1)
            filename=$(basename "$apk")
            echo "- ðŸ“± \`$filename\` ($size)" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“¥ ä¸‹è½½é“¾æŽ¥**: åœ¨é¡µé¢åº•éƒ¨çš„ArtifactsåŒºåŸŸä¸‹è½½APKæ–‡ä»¶" >> $GITHUB_STEP_SUMMARY
        else
          echo "âŒ **APKæž„å»ºå¤±è´¥**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ” æ•…éšœæŽ’é™¤å»ºè®®:**" >> $GITHUB_STEP_SUMMARY
          echo "1. æ£€æŸ¥æž„å»ºæ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯" >> $GITHUB_STEP_SUMMARY
          echo "2. ç¡®è®¤ \`buildozer.spec\` é…ç½®æ–‡ä»¶æ­£ç¡®" >> $GITHUB_STEP_SUMMARY
          echo "3. éªŒè¯é¡¹ç›®ä¾èµ–æ˜¯å¦å®Œæ•´" >> $GITHUB_STEP_SUMMARY
          echo "4. æŸ¥çœ‹ \`.buildozer\` ç›®å½•ä¸­çš„è¯¦ç»†æ—¥å¿—" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "*æ­¤æž„å»ºç”±GitHub Actionsè‡ªåŠ¨ç”Ÿæˆ*" >> $GITHUB_STEP_SUMMARY